# 지표수집과 모니터링

해당 내용은 [대용량 서비스를 위한 아키텍처](https://fastcampus.app/courses/205143) 강의를 듣고 공부한 내용입니다.

## 지표수집
> 서비스가 제대로 동작하고 있는지 파악하는 지표

지표는 서비스에서의 지표와, 서비스 노드 지표 크게 두가지로 구분할 수 있다. 

</br>

### 서비스 지표

* **API call 수**

현재 요청중인 api call 수가 어떻게 되는지, 그중 몇개가 성공하고 몇개가 실패하고 있는지를 나타내는 지표.
실패의 비중이 너무 많다면 에러의 종류는 db 혹은 없는 페이지를 찾는 에러인지가 구분이 되어야 한다. 

* **API Latency**

Latency는 일반적으로 평균값이 아닌 중간값을 본다. 예를들어 latency 1초와 0.01초가 있으면 평균값은 0.5 정도가 된다. 때문에 중간값이 얼마인지가 더 중요하다.
또 중간값 뿐만 아니라 90%, 95%, 99% 유저는 몇 초 안에 응답을 받는다 등의 범위를 나눠서 체크하는 것이 필요하다. 

</br>

### 서비스 노드 지표

* **서버의 상태 (잘 살아있는지)**
* **CPU 사용량 (DB 및 API 서버, Cache 서버의 CPU 사용량)**
* **메모리 사용량 (oom, swap 방지)**
* **디스크 사용량**
* **네트워크 사용량 (파일이나 데이터의 전송량은?)**
* **현재 동작중인 정상적인 서버의 수**

</br>

## 모니터링
> prometheus, grafana, sentry 등

이러한 서비스 지표들을 수집하고 시각화 하기 위해 일반적으로 prometheus로 지표를 수집하고 grafana로 시각화한다.    
에러 로그 수집의 경우 sentry를 사용하여 수집하고 급감 및 에러가 튀고 있는 현상, 혹은 새로운 서비스가 문제없이 동작하는지 등을 을 파악할 수 있다.    
또 수집한 지표를 바탕으로 서버의 디스크가 95% 이상이 되면 알람을 보내는 등의 설정도 가능하다. (slack 등 메신저로 알리는 등)
알람의 경우 등급을 나누어서 긴급 대응해야 할 이슈인지, 아닌지를 판별하게 하는 것이 좋다. 

* **Prometheus**

모니터링을 위해서는 단순히 하니의 API 서비스의 성공 실패 뿐만 아니라, 연결되는 다른 서비스들에 대한 모니터링을 할 수 있어야 한다. Prometheus의 경우 exporter라는 agent를 통해서 여러가지 필요한 툴들의 모니터링이 가능하므로 모니터링 서비스에 적합하다.   
mysal, redis 등의 컴포넌트에 대한 metric 수집을 위한 exporter가 이미 존재하고 각 서버 노드의 필요정보(CPU사용량, 메모리 사용량, alive 여부, 네트워크 사용량)에 대해서도 exporter가 이미 존해한다.    
또한 데이터의 수집을 pull 방식을 이용하기 떄문에 prometheus 자체에 문데가 발생하더라도 모니터링 호스트에 장애가 전달되지 않는다!   
다만 Prometheus는 자체적으로 HA를 제공해주지 않기 때문에 Cortex 등 다른 툴의 도움을 받아야 한다. 


* **Grafana**

Prometheus에서도 간단한 그래프를 이용해서 데이터의 시각화가 가능하지만 Grafana를 적용하여 더 다양한 지프 및 대시보드 형성을 할 수 있다. 이미 제공되는 대시보드 템플릿이 많은것도 장점이다. 


* 대체(Alternatives)
  - InfluxDB
  - DataDog, New Relic, WhaTop 등의 PaaS (DataDog과 New Relic은 모니터링 알람 이외에 로그수집, APM 기능까지 제공)
