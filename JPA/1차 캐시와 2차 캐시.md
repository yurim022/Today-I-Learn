# JPA의 1차 캐시와 2차 캐시

![image](https://user-images.githubusercontent.com/45115557/195528645-91ed8194-0c66-4453-a628-b65e4391473a.png)

이미지 출처: https://devbksheen.tistory.com/entry/JPA-1%EC%B0%A8-%EC%BA%90%EC%8B%9C%EC%99%80-2%EC%B0%A8-%EC%BA%90%EC%8B%9C-%EC%86%8C%EA%B0%9C   

네트워크를 통해 데이터베이스에 접근하는 시간 비용은 애플리케이션 서버 내부 메모리에 접근하는 시간보다 수만에서 수십만배 비싸다. 조회한 데이터를 메모리에 캐싱해두면 데이터베이스 접근 횟수를 줄여 성능을 개선할 수 있고, 
JPA에서도 캐싱을 사용하고 있다. 

## 1차 캐시

![image](https://user-images.githubusercontent.com/45115557/195525754-620f1ca8-8fcd-459d-b702-a0ed898a1a4e.png)

이미지 출처:  https://willseungh0.tistory.com/77   

영속성 컨텍스트 내부에는 엔티티를 보관하는 저장소가 있는데 이를 1차 캐시라고 한다. 엔티티 매니저로 조회하거나 변경하는 모든 엔티티는 1차 캐시에 저장되며, 트랜잭션을 커밋하거나 플러시를 호출하면 1차 캐시에 있는
엔티티의 변경 내역을 데이터베이스에 동기화한다. 일반적으로 JPA는 스프링 프레임워크 같은 컨테이너 위에서 실행하면 트랜잭션을 시작하거나 종료할 때 영속성 컨텍스트도 시작하거나 종료한다. (OSIV 제외)
일반적으로 **트랜잭션을 시작하고 종료할때까지** 1차 캐시가 유효하다. 
1차 캐시 내에서 같은 엔티티가 있으면 객체 동일성을 보장한다. 

</br>

## 2차 캐시

![image](https://user-images.githubusercontent.com/45115557/195528266-627cb2e5-69c6-4de7-8cf4-e7e924c2b4eb.png)

이미지 출처:  https://willseungh0.tistory.com/77   

2차 캐시(second level cache, L2 cache)는 애플리케이션 범위의 캐시로, 공유 캐시(shared cache)라고도 한다. **애플리캐이션을 종료할 때까지** 캐시가 존재한다.    
2차 캐시는 동시성을 극대화하기 위해 캐시한 객체를 직접 반환하지 않고 복사본을 만들어서 반환하는데, 캐시 객체를 그대로 반환하면 여러 곳에서 같은 객체를 동시에 수정하는 동시성 문제가 발생할 수 있기 때문이다.캐ㅅ
캐시 객체를 반환하면서 동기화를 유지하기 위해선 객체에 락을 걸어야 하는데 이는 동시성을 저하시킨다. 
때문에 **2차캐시는 영속성 컨텍스트가 다르면 객체 동일성을 보장하지 않는다.**

참고링크:
https://willseungh0.tistory.com/77   
https://devbksheen.tistory.com/entry/JPA-1%EC%B0%A8-%EC%BA%90%EC%8B%9C%EC%99%80-2%EC%B0%A8-%EC%BA%90%EC%8B%9C-%EC%86%8C%EA%B0%9C   
